name: Deploy to Azure

on:
  # Trigger on PR merge to main (when PR is closed and merged)
  pull_request:
    types: [closed]
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:

# Required permissions for Azure login with OIDC
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    # Only run if PR was actually merged (not just closed)
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ secrets.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Azure Developer CLI
        run: |
          # Install azd using the official install script with retry logic
          for i in 1 2 3; do
            echo "Attempt $i to install azd..."
            if curl -fsSL https://aka.ms/install-azd.sh | bash; then
              echo "azd installed successfully"
              break
            else
              echo "Install attempt $i failed"
              if [ $i -eq 3 ]; then
                echo "Failed to install azd after 3 attempts"
                exit 1
              fi
              sleep 5
            fi
          done
          
          # Add azd to PATH
          if [ -d "$HOME/.azd/bin" ]; then
            echo "$HOME/.azd/bin" >> $GITHUB_PATH
          fi
        shell: bash

      - name: Verify azd installation
        run: |
          export PATH="$HOME/.azd/bin:$PATH"
          azd version
        shell: bash

      - name: Log in to Azure with OIDC
        uses: azure/login@v1.6.1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure azd environment
        run: |
          export PATH="$HOME/.azd/bin:$PATH"
          
          # Decode and restore environment configuration if provided
          if [ -n "$AZD_INITIAL_ENVIRONMENT_CONFIG" ]; then
            echo "Restoring environment configuration from secret..."
            if echo "$AZD_INITIAL_ENVIRONMENT_CONFIG" | base64 -d > .env.azd 2>/dev/null; then
              echo "Successfully decoded environment config"
              azd env refresh -e $AZURE_ENV_NAME --from-dotenv .env.azd || echo "Warning: Could not refresh environment from config"
            else
              echo "Warning: Could not decode AZD_INITIAL_ENVIRONMENT_CONFIG - will create fresh environment"
            fi
          else
            echo "No AZD_INITIAL_ENVIRONMENT_CONFIG provided - creating fresh environment"
          fi
          
          # Ensure environment exists
          echo "Setting up azd environment: $AZURE_ENV_NAME"
          azd env select $AZURE_ENV_NAME 2>/dev/null || azd env new $AZURE_ENV_NAME
          
          # Set required values
          echo "Configuring Azure settings..."
          azd env set AZURE_LOCATION $AZURE_LOCATION
          azd env set AZURE_SUBSCRIPTION_ID $AZURE_SUBSCRIPTION_ID
          
          echo "Environment configuration complete"
        env:
          AZD_INITIAL_ENVIRONMENT_CONFIG: ${{ secrets.AZD_INITIAL_ENVIRONMENT_CONFIG }}
        shell: bash

      - name: Provision and Deploy to Azure
        run: |
          export PATH="$HOME/.azd/bin:$PATH"
          azd up --no-prompt
        shell: bash

      - name: Deployment Summary
        if: success()
        run: |
          export PATH="$HOME/.azd/bin:$PATH"
          echo "‚úÖ Deployment successful!"
          echo "üåê Application URL: $(azd env get-values | grep APP_SERVICE_URL | cut -d'=' -f2)"
        shell: bash
